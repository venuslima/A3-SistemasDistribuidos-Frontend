<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="styles/style.css" rel="stylesheet">
    <title>Gerenciar Produtos</title>
    <li><a class="btn" href="index.html"> Voltar </a></li>
</head>

<body>
    <h1>Gerenciar Produtos</h1>


    <h2>Categorias</h2>
    <form id="formCategoria">
        <input id="nomeCategoria" type="text" placeholder="Nova Categoria">
        <input id="tamanho" type="text" placeholder="Tamanho">
        <input id="embalagem" type="text" placeholder="Embalagem">
        <button type="submit">Adicionar Categoria</button>
    </form>

    
    <table border="1" id="selectCategoria" class="scrollTable">
        <thead>
            <th>Categorias</th>
        </thead>
        <tbody></tbody>
    </table> 




    <h2>Incluir Produto</h2>
    <form id="formAdd">
        
        <input id="nome" type="text" placeholder="Nome do produto"><br>
        <input id="preco" type="number" step="any" placeholder="Preço"><br>
        <input id="quantidade" type="number" placeholder="Quantidade"><br>
        <input id="quantidadeMin" type="number" placeholder="Quantidade Mínima"><br>
        <input id="quantidadeMax" type="number" placeholder="Quantidade Máxima"><br>
        <select id="selectCategoriaProduto"></select><br>
        
        <button type="submit">Adicionar</button>
    </form>

    




    <h2>Alterar Produto</h2>
    <select id="selectEditar">
        <option value="" disabled selected>Selecione um produto</option>
    </select>
    <button onclick="editarProduto()">Editar</button>
    <button onclick="excluirProduto()">Excluir</button>



    <table  border="1">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Preço</th>
                <th>Quantidade</th>
                <th>Qtd. Mínima</th>
                <th>Qtd. Máxima</th>
                <th>Categoria</th>
            </tr>
        </thead>
        <tbody>
            <td><span id="nomeSelecionado"></span></td>
            <td><span id="precoSelecionado"></span></td>
            <td><span id="quantidadeSelecionado"></span></td>
            <td><span id="quantidadeMinSelecionado"></span></td>
            <td><span id="quantidadeMaxSelecionado"></span></td>
            <td><span id="categoriaSelecionada"></span></td>
        </tbody>
    </table>



    <script>
        const API_ITEM = "http://localhost:8080/item";
        const API_CATEGORIA = "http://localhost:8080/categoria";

        let listaItens = [];
        let listaCategorias = [];


        async function carregarCategorias() {
            const resp = await fetch(API_CATEGORIA);
            listaCategorias = await resp.json();
            listaCat = listaCategorias;

            
            const selCatProduto = document.getElementById("selectCategoriaProduto");
            selCatProduto.innerHTML = '<option value="" disabled selected>Selecione uma categoria</option>';

            listaCategorias.forEach(c => {
                const texto = `${c.nome} (${c.tamanho}, ${c.embalagem})`;
                
                const opt2 = document.createElement("option");
                opt2.value = c.id;
                opt2.textContent = texto;
                selCatProduto.appendChild(opt2);

            });

            const tabela = document.querySelector("#selectCategoria tbody");
            tabela.innerHTML = "";

            listaCat.forEach(categoria => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${categoria.nome} (${categoria.tamanho}, ${categoria.embalagem})</td>
                `;
                tabela.appendChild(tr);
            });


        }


        document.getElementById("formCategoria").addEventListener("submit", async e => {
            e.preventDefault();
            const nome = document.getElementById("nomeCategoria").value;
            const embalagem = document.getElementById("embalagem").value;
            const tamanho = document.getElementById("tamanho").value;

            if (!nome || !embalagem || !tamanho) return alert("Preencha todos os campos!");

            await fetch(API_CATEGORIA, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nome, embalagem, tamanho })
            });

            document.getElementById("nomeCategoria").value = "";
            document.getElementById("embalagem").value = "";
            document.getElementById("tamanho").value = "";
            await carregarCategorias();
            alert("Categoria criada!");
        });

        carregarCategorias();


        async function carregarProdutos() {
            const resp = await fetch(API_ITEM);
            listaItens = await resp.json();

            const selEditar = document.getElementById("selectEditar");
            selEditar.innerHTML = '<option value="" disabled selected>Selecione um produto</option>';

            listaItens.forEach(item => {
                const opt = document.createElement("option");
                opt.value = item.id;
                opt.textContent = item.nome;
                selEditar.appendChild(opt);
            });
        }


        document.getElementById("formAdd").addEventListener("submit", async e => {
            e.preventDefault();

            const produto = {
                nome: document.getElementById("nome").value,
                preco: Number(document.getElementById("preco").value),
                quantidade: Number(document.getElementById("quantidade").value),
                quantidadeMin: Number(document.getElementById("quantidadeMin").value),
                quantidadeMax: Number(document.getElementById("quantidadeMax").value),
                categoria: { id: Number(document.getElementById("selectCategoriaProduto").value) }
            };

            await fetch(API_ITEM, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(produto)
            });

            await carregarProdutos();
            alert("Produto adicionado!");
        });


        document.getElementById("selectEditar").addEventListener("change", function () {
            const id = Number(this.value);
            const produto = listaItens.find(p => p.id === id);
            if (!produto) return;

            document.getElementById("nomeSelecionado").textContent = produto.nome;
            document.getElementById("precoSelecionado").textContent = produto.preco;
            document.getElementById("quantidadeSelecionado").textContent = produto.quantidade;
            document.getElementById("quantidadeMinSelecionado").textContent = produto.quantidadeMin;
            document.getElementById("quantidadeMaxSelecionado").textContent = produto.quantidadeMax;
            document.getElementById("categoriaSelecionada").textContent = produto.categoria ? produto.categoria.nome : "";
        });


        async function editarProduto() {
            const id = document.getElementById("selectEditar").value;
            if (!id) { alert("Selecione um produto antes de editar!"); return; }

            const produto = listaItens.find(p => p.id == id);
            if (!produto) { alert("Produto não encontrado!"); return; }

            const novoNome = prompt("Novo Nome:", produto.nome);
            const novoPreco = prompt("Novo Preço:", produto.preco);
            const novaQtde = prompt("Nova Quantidade:", produto.quantidade);
            const novaQtdeMin = prompt("Nova Qtd. Mínima:", produto.quantidadeMin);
            const novaQtdeMax = prompt("Nova Qtd. Máxima:", produto.quantidadeMax);
            const novaCategoriaId = document.getElementById("selectCategoriaProduto").value || (produto.categoria ? produto.categoria.id : "");

            const produtoAtualizado = {
                nome: novoNome || produto.nome,
                preco: novoPreco ? Number(novoPreco) : produto.preco,
                quantidade: novaQtde ? Number(novaQtde) : produto.quantidade,
                quantidadeMin: novaQtdeMin ? Number(novaQtdeMin) : produto.quantidadeMin,
                quantidadeMax: novaQtdeMax ? Number(novaQtdeMax) : produto.quantidadeMax,
                categoria: { id: Number(novaCategoriaId) }
            };

            await fetch(`${API_ITEM}/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(produtoAtualizado)
            });

            await carregarProdutos();
            document.getElementById("selectEditar").value = id;
            document.getElementById("selectEditar").dispatchEvent(new Event('change'));
            alert("Produto atualizado!");
        }


        async function excluirProduto() {
            const id = document.getElementById("selectEditar").value;
            if (!id) return;

            await fetch(`${API_ITEM}/${id}`, { method: "DELETE" });
            await carregarProdutos();
            alert("Produto excluído!");
        }


        carregarCategorias();
        carregarProdutos();
    </script>
</body>

</html>